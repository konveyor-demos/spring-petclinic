= Cloud Migration Workshop
:icons: font
:toc: left
:toclevels: 3
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

[.lead]
Migrate applications to the cloud
****
This workshop is about migrating applications to the cloud.
It is based on the Konveyor framework, in particular on its Kantra tool, which

* analyzes (Java) applications for cloud readiness, and
* supports the migration of (Java) applications to the cloud.

We concentrate on Java
and use a simple example application to demonstrate the migration process.
The principles and tools can be applied to other languages and applications as well (with some limitations).

[NOTE]
====
Konveyor is a community-driven project that aims to help organizations modernize their applications and infrastructure.
It is part of the Cloud Native Computing Foundation (CNCF).

The workshop is based on the Kantra tool, which is part of the Konveyor project.
Konveyor is usually installed via the OperatorHub in OpenShift or Kubernetes,
while Kantra can run in any container environment.
====
****

== Preparations

[IMPORTANT]
.Use a Linux shell
====
If you are running on Windows, please use either of the following:

* A `bash` (usually part of the Git installation),
* The Windows Subsystem for Linux (WSL), or
* A Linux VM.
====

* Install either
** https://podman.io/[Podman] (recommended by
Konveyor), or
** https://rancherdesktop.io/[Rancher], or
** https://www.docker.com/[Docker] (*recommended*, as we used in the workshop examples).

+
[IMPORTANT]
.Docker environment settings or Podman usage
====
* In case you use _Docker_, you need to set the following environment variable:
+
[source, bash]
export PODMAN_BIN=docker

* In case you use Podman, you need to use `podman` instead of `docker` in the examples.
We will support this by using an environment variable `DOCKER_BIN` in the examples.
+
[source, bash]
export DOCKER_BIN=podman

We recommend using https://direnv.net/[direnv] to set this variable(s) automatically.
====

* Clone this repository and change your shell directory to it.
+
[source, bash]
----
git clone https://github.com/konveyor-demos/spring-petclinic.git
cd spring-petclinic # <1>
----
<1> Perform all subsequent commands in this directory.

+
[TIP]
====
You may use link:WORKSHOP.adoc[this file] (`WORKSHOP.adoc`) for your convenience to copy/paste] commands.
It works best with an `asciidoctor` plugin for your IDE, e.g., the https://intellij-asciidoc-plugin.ahus1.de/docs/users-guide/index.html[IntelliJ Plugin].
====

* Switch to the workshop branch.
+
[source, bash]
git checkout workshop

* Build the Spring PetClinic application for container usage
+
[source, bash]
----
${DOCKER_BIN:-docker} compose build
----

* Install Java 11 or higher (optional, but recommended), e.g., with https://sdkman.io/[SDKMAN!].
* Install Kantra by following the https://github.com/konveyor/kantra?tab=readme-ov-file#downloading-stable-release[installation instructions].
+
[TIP]
====
In case you want to use the latest version, you can execute the link:scripts/get-kantra.sh[get-kantra.sh] script to download and install Kantra for your convenience.

[source, bash]
----
./scripts/get-kantra.sh
----
====

== Exercises

=== Exercise 1: Run a (scaled) Spring PetClinic application

==== Start with initial application

. Start the Spring PetClinic application in a container.
+
[source, bash]
----
${DOCKER_BIN:-docker} compose up -d
----

. Upload some images (cf. link:scripts/upload-dummy-image.sh[upload-dummy-image.sh]).
+
[source, bash]
----
./scripts/upload-dummy-image.sh
# -> Image uploaded successfully
----

. List the uploaded images (cf. link:scripts/list-images.sh[list-images.sh]).
+
[source, bash]
----
./scripts/list-images.sh
# -> Image list: ...
----

==== Scale up

. Now, scale the application to more (>= 2) replicas.
+
[source, bash]
----
${DOCKER_BIN:-docker} compose up -d --scale petclinic=2
${DOCKER_BIN:-docker} compose restart nginx # necessary to update the load balancer
----

. List the uploaded images again.
You should see that the images are distributed across the replicas.
Either

** You get the list as before:
+
[source, bash]
----
./scripts/list-images.sh
# -> Image list: ...
----
** Or, you get an empty list:
+
[source, bash]
----
./scripts/list-images.sh
# -> []
----

. If you add more images, you will even see that they are distributed across the replicas.

==== Solution 1a: Running Kantra (Minimal) for Analysis

* Run Kantra with the following command.
+
[source, bash]
.Run Kantra (Cloud Readiness)
----
ifndef::env-github[]
kantra \# <1>
  analyze \# <2>
  --overwrite \# <3>
  -i . \# <4>
  -o ../out \# <5>
  --mode source-only \# <6>
  --target cloud-readiness # <7>
endif::env-github[]
ifdef::env-github[]
kantra \
  analyze \
  --overwrite \
  -i . \
  -o ../out \
  --mode source-only \
  --target cloud-readiness
endif::env-github[]
----
<1> Is `kantra` in `+${PATH}+`? Otherwise, for example, `../kantra`
<2> Kantra sub-command `analyze` (see `kantra help`)
<3> Overwrite existing results
<4> Input: Current directory
<5> Output: Directory outside the current directory
<6> Analyze only your own source code, no dependencies
<7> Minimal target: Cloud migration (generic)

* Open the resulting report in your browser.
+
[source, bash]
.Open the report
----
open ../out/static-report/index.html
----

* Check the report for the Spring PetClinic application.
+
image::images/initial-konveyor-analysis.png[alt="Initial Konveyor Analysis of Spring PetClinic"]

[[sec:solution_1b_improved_kantra_analysis]]
==== Solution 1b: Improved Kantra Analysis

There are better targets for the analysis (with better reporting).

* List the available targets.
+
[source, bash]
----
kantra analyze --list-targets
----

* Choose `azure-aks` as the target.
+
[source, bash]
----
ifndef::env-github[]
kantra \# <1>
  analyze \
  --overwrite \
  -i . \
  -o ../out \
  --mode source-only \
  --target azure-aks # <2>
endif::env-github[]
ifdef::env-github[]
kantra \
  analyze \
  --overwrite \
  -i . \
  -o ../out \
  --mode source-only \
  --target azure-aks
endif::env-github[]
----
<1> Mind the `+${PATH}+`!
<2> The target `azure-aks` is a more specific target which provides better reporting.

* Check the extended report in your browser.
+
image::images/extended-konveyor-analysis-with-azure-aks.png[alt="Extended Analysis Report with target azure-aks"]

=== Exercise 2: Migrate to current Spring Boot (3.x)

Run the PetClinic (once again) to see if it builds and view the version.

[source, bash]
----
mvn spring-boot:run
----

Look at the Log Output of the Spring Boot application.
You should see its running Spring 2.6.6.

[source, console]
----
...
:: Built with Spring Boot :: 2.6.6
...
----


==== Extend the POM by OpenRewrite (optional)

* Extend the `pom.xml` by the OpenRewrite Maven plugin.
+
[source, xml]
.OpenRewrite Maven Plugin -> `pom.xml`
----
<plugin>
  <groupId>org.openrewrite.maven</groupId>
  <artifactId>rewrite-maven-plugin</artifactId>
  <version>5.27.0</version>
  <configuration>
    <activeRecipes>
      <recipe>org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2</recipe>
    </activeRecipes>
    <activeStyles>
      <style>org.openrewrite.java.SpringFormat</style>
    </activeStyles>
  </configuration>
  <dependencies>
    <dependency>
      <groupId>org.openrewrite.recipe</groupId>
      <artifactId>rewrite-spring</artifactId>
      <version>5.7.0</version>
    </dependency>
  </dependencies>
</plugin>
----

[NOTE]
====
The SpringFormat style is defined under `activeStyles`,
so that OpenRewrite automatically formats in the way Spring expects it.
This should prevent any formatting issues after the transformation,
but does not format everything in a way that fulfills the validation of the Spring Format tool.
====

* Then run the OpenRewrite Maven plugin.
+
[source, bash]
----
./mvnw rewrite:run
----

==== Run OpenRewrite full CLI (alternative)

Alternatively, you may run OpenRewrite completely from the command line.

[source, bash]
----
./mvnw org.openrewrite.maven:rewrite-maven-plugin:run \
  -Drewrite.activeRecipes=org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_2
----

==== Solution 2

When OpenRewrite has successfully applied its rules,
you still may see several problems before you are back with a running application.
Several of the following enhancements may be necessary to get it going again.

Fix formatting of updated code::
Reformat the code as the Maven build will break otherwise.
+
[source, bash]
----
./mvnw spring-javaformat:apply
----

Fix missing dependencies::
Some classes will not build any longer due to a missing XML dependency.
+
[source, xml]
.Add dependency to POM
----
<dependency>
  <groupId>jakarta.xml.bind</groupId>
  <artifactId>jakarta.xml.bind-api</artifactId>
</dependency>
----

Test/Execute the updated application::
+
[source, bash]
----
./mvnw package spring-boot:run
----
+
[CAUTION]
.Switch to Java 17 (or higher)
====
Now you will need Java 17 to run the application.
====

Clean up properties and configurations (optional)::
Your IDE and peer reviewer(s) may complain over strange properties and configurations in the `pom.xml`.

Add missing plugin version (optional)::
Maven may complain about a missing version for a plugin.
Arbitrary executions of Maven may result in output like this.
+
[source, console]
----
[WARNING]
[WARNING] Some problems were encountered while building the effective model for org.springframework.samples:spring-petclinic:jar:2.6.0-SNAPSHOT
[WARNING] 'build.plugins.plugin.version' for pl.project13.maven:git-commit-id-plugin is missing. @ line 243, column 15
[WARNING]
[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.
[WARNING]
[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.
[WARNING]
----

Switch to Java 17 for Docker build::
Running a Docker build may reveal strange error messages, e.g., about mismatching class files.
Resolve this by bumping the JDK and JRE version numbers of the Docker build and runtime images to 17.

Fix Docker build dependency loads::
The Docker build was optimized by first downloading all dependencies before starting the build itself.
In case there was no change in Maven or its configuration, Docker could cache the downloaded dependencies and plugins.
However, some of the dependencies (Glassfish and EH-Cache) seem to have transitive dependency resolution issues.
For some reason, they seem not to be used (at least in).
Hence, we drop them to re-enable Docker builds with proper caching again.
+
[CAUTION]
====
Even though dropping these dependencies does not yet result in build or test errors,
this doesn't mean that the dropped components are not used any longer.
====

==== Diffs to `main`

Note that your result will differ in many points from the manually crafted updates on the `main` branch!
The project now mostly contains code changes which come from the automatic rule application of OpenRewrite.
In particular, it now lacks changes

* Wrt. semantic problems of code,
* To documentation,
* To messages,
* To the build tools (Maven and Gradle wrappers, GitHub actions, shell scripts, etc.),
* To the UI/HTML (including CSS, Images, etc.),
* ...

=== Exercise 3: Migrate from local File Access to Storage Service

Though we now have switched to the current Spring Boot 3,
the application is still working with a local file store
as found out in the <<sec:solution_1b_improved_kantra_analysis,Kantra analysis of exercise 1>>.
This requires an architectural change (re-architect).
We would like to store the files in a respective storage service
as provided by the underlying cloud provider or platform.

As we can or will not use any real cloud provider in the workshop,
we propose to use a local implementation of AWS S3 with https://www.localstack.cloud/[LocalStack].

Whatever solution you choose, it most probably affects the following parts of your implementation:

* Cloud Stack (local link:docker-compose.yml[Docker compose] file).
* Configuration (link:src/main/resources/application.properties[application properties], perhaps Spring profiles).
* Dependency management (link:pom.xml[Maven configuration]).
* Implementation (of at least link:src/main/java/org/springframework/samples/petclinic/images/ImageController.java[ImageController],
beyond switching the underlying storage, you may have to introduce further configurations, tests etc.).

